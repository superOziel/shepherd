
<div class="d-flex justify-content-center" id="loading">
  <div class="spinner-border" role="status">
    <span class="sr-only">Loading...</span>
  </div>
</div>

<div id="commitment_info" style="display:none">
    <div class="row">
        <div class="col-sm-12">
            <div class="col-sm-10">
                <b>Assembly Order: @ViewBag.Assembly / Item #: @ViewBag.SO_Item / @ViewBag.Item_Description</b> 
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-sm-12">
            <div class="col-sm-6" style="text-align: left">   
                <b style="text-align: left">Project #: @ViewBag.SO_Project</b>
            </div>
            <div class="col-sm-6" style="text-align: right">
                <b style="text-align:right"><a href="/#" id="view">View</a></b>
            </div>
        </div>
    </div>
</div>
<div class="row">
     
</div>

<div class="row margin-top-10" id="headers" style="display: none">
    <div class="col-sm-4"></div>
    <div class="col-sm-3 text-align-center bold">Start</div>
    <div class="col-sm-2">&nbsp;</div>
    <div class="col-sm-3 text-align-center bold">End</div>
</div>

<div class="card" id="commitment_capture" style="display: none">
    <ul class="list-group list-group-flush no-marginbottom" >
        <li class="list-group-item" style="background-color:#ddd">
            <div class="col-sm-4 text-align-right bold">Casting Release: </div>
            <div class="col-sm-5"></div>
            <div class="col-sm-3">
                <div class='input-group date' id='castingdate'>
                    <input type='text' class="form-control" id="castingdateval" autocomplete="off" onkeydown="return false" />
                    <span class="input-group-addon">
                        <span class="glyphicon glyphicon-calendar"></span>
                    </span>
                </div>
            </div>

            <div class="col-sm-4 margin-top-10 text-align-right bold">Required BOM Complete:</div>
            <div class="col-sm-5 margin-top-10"></div>
            <div class="col-sm-3 margin-top-10">
                <div class='input-group date' id='bomdate'>
                    <input type='text' class="form-control" id="bomdatevalue" autocomplete="off" onkeydown="return false"/>
                    <span class="input-group-addon">
                        <span class="glyphicon glyphicon-calendar"></span>
                    </span>
                </div>
            </div>
        </li>
        <li class="list-group-item" style="background-color:#c0c1c1">
            <div class="col-sm-4 bold text-align-right"> Buyouts & Remaining Parts: </div>
            <div class="col-sm-5"> &nbsp;</div>
            <div class="col-sm-3 text-align-center"> <label id="boyoutdate"></label>&nbsp;</div>

            <div class="col-sm-4 bold text-align-right">Fabrications: </div>
            <div class="col-sm-5"> &nbsp;</div>
            <div class="col-sm-3 text-align-center"> <label id="fabrications"></label>&nbsp;</div>

            <div class="col-sm-4 bold text-align-right">Foundry: </div>
            <div class="col-sm-5"> &nbsp;</div>
            <div class="col-sm-3 text-align-center"> <label id="foundry"></label>&nbsp;</div>

            <div class="col-sm-4 bold text-align-right">Release to Manufacturing: </div>
            <div class="col-sm-5"> &nbsp;</div>
            <div class="col-sm-3 text-align-center"> <label id="manufacturing"></label>&nbsp;</div>

            <div class="col-sm-4 text-align-right"> <label class="vertical-align-center">Machining:</label>&nbsp;</div>
            <div class="col-sm-3 text-align-center"> <label id="machiningstart" class="vertical-align-center"></label>&nbsp;</div>
            <div class="col-sm-2" style="height:24px"> <input type="text" class="form-control height-sm" id="machining_days" placeholder="Days" autocomplete="off" disabled>&nbsp;</div>
            <div class="col-sm-3 text-align-center"> <label id="machiningend" class="vertical-align-center"></label>&nbsp;</div>

        </li>
        <li class="list-group-item" style="background-color:#b3c3d0">
            <div class="col-sm-4 bold text-align-right">Componets: </div>
            <div class="col-sm-5"> &nbsp;</div>
            <div class="col-sm-3 text-align-center"> <label id="componentdate"></label>&nbsp;</div>
           
            <div class="col-sm-12 no-padding-sides" >
                <div class="col-sm-4 text-align-right"> <label class="vertical-align-center">Assembly:</label>&nbsp;</div>
                <div class="col-sm-3 text-align-center"> <label id="assemblydayscalculated" class="vertical-align-center"></label>&nbsp;</div>
                <div class="col-sm-2" style="height:24px"> <input type="text" class="form-control height-sm" id="assembly_days" placeholder="Days" autocomplete="off" disabled>&nbsp;</div>
                <div class="col-sm-3 text-align-center"> <label id="assemblystart" class="vertical-align-center"></label>&nbsp;</div>
            </div>
            
            <div style="background-color: blue">
                <div class="col-sm-4 bold text-align-right"> <span class="vertical-align-center">Ready to ship: </span></div>
                <div class="col-sm-5"> &nbsp;</div>
                <div class="col-sm-3 text-align-center"> <label id="readytoship"></label>&nbsp;</div>
            </div>
            
            <div class="col-sm-4 text-align-right"> <label class="vertical-align-center">Buffer:</label>&nbsp;</div>
            <div class="col-sm-3 text-align-center"> <label id="finalbuffercalculated" class="vertical-align-center"></label>&nbsp;</div>
            <div class="col-sm-2" style="height:24px"> <input type="text" class="form-control height-sm" id="final_buffer" placeholder="Days" autocomplete="off" >&nbsp;</div>
            <div class="col-sm-3 text-align-center"> <label class="vertical-align-center" id="maxdelivdate">@ViewBag.MaxDelivDateStr</label>&nbsp;</div>
        </li>
  </ul>
</div>
<script type="text/javascript">
    $(document).ready(function () {
        $('.spinner-border').hide();
        $('#commitment_info').show();
        $('#commitment_capture').show();
        $('#headers').show();

        $('#bomdate').datetimepicker({
            format: 'MM/DD/YYYY',
        }).on('dp.change', function (e) {
            removeDisabledButton();
        });

        $('#castingdate').datetimepicker({
            format: 'MM/DD/YYYY',
        }).on('dp.change', function (e) {
            removeDisabledButton();
        });

        var assembly_order;
        var final_buffer;
        var assembly_days;
        var componentdate;
        var boyout_remaining;
        var machining_start;
        var MaxDelivDateStr = moment('@ViewBag.MaxDelivDateStr');
        var assemblydayscalculated;

        var daysBuffer = '@ViewBag.DaysBuffer'

        $('#readytoshipdiv').hide();
        $('#boyoutdatediv').hide();
        $('#fabricationsdiv').hide();
        $('#foundrydiv').hide();
        $('#manufacturingdiv').hide();

        $('#componentdatediv').hide();
        $('#remainingpartdiv').hide();
        $('#machiningenddiv').hide();
        $('#machiningstartdiv').hide();

        var permission_user = '@ViewBag.Permission_user' == "False" ? false : true;
        console.log("Permiso en Modal de Compromiso ", '@ViewBag.Permission_user')

        if (!permission_user) {
            $("#final_buffer").attr('disabled', 'disabled');
            $("#assembly_days").attr('disabled', 'disabled');
            $("#machining_days").attr('disabled', 'disabled');
            $("#bomdatevalue").attr('disabled', 'disabled');
            $("#castingdateval").attr('disabled', 'disabled');
            $("#reset").attr('disabled', 'disabled');

        }

        $('#final_buffer').change(function (data) {
            calculateFinalBuffer();
            removeDisabledButton();

            if ($('#assembly_days').val()) {
                calculateAssemblyDays();
            }

            if ($('#machining_days').val()) {
                calculateMachiningStart();
            }
        });

        $('#assembly_days').change(function (data) {
            calculateAssemblyDays();
            removeDisabledButton();

            if ($("#machining_days").val()) {
                calculateMachiningStart();
            }
        });

        $('#machining_days').change(function () {
            //Machining start
            calculateMachiningStart();
            removeDisabledButton();

        });

        $("#bomdatevalue").change(function (data) {
            console.log("bom date change", data)
            removeDisabledButton();
        });

        $("#castingdate").change(function () {
            removeDisabledButton();
        });

        assembly_order = '@ViewBag.Assembly';
        var SO_Nr = '@ViewBag.SO_Nr';
        var SO_Ln = '@ViewBag.SO_Ln';
        var SO_Sq = '@ViewBag.SO_Sq';
        var data = {
            ProdOrderNr: assembly_order,
            SO_Nr: SO_Nr,
            SO_Ln: SO_Ln,
            SO_Sq: SO_Sq,
        }
        console.log("data?", data);
        getCommitment();

        function getCommitment() {
            console.log("inicio get commitment")
            $.ajax({
                type: 'GET',
                data: data,
                //?assembly_number=' + assembly_order
                url: '/Commitment/GetCommitment',
                contentType: 'application/json; charset=utf-8',
                success: function (commitment) {
                    console.log("Commitment en getCommmitment", commitment)

                    if (commitment != null) {
                        console.log("tiene commitment: ", commitment);
                        $("#final_buffer").val(commitment.final_buffer);
                        $("#assembly_days").val(commitment.assembly_days);
                        $("#machining_days").val(commitment.machining_days);
                        $('#bomdate').data({ date: moment(commitment.bom_date).format('MM/DD/YYYY') });
                        $('#castingdate').data({ date: moment(commitment.casting_date).format('MM/DD/YYYY') });
                        $('#bomdatevalue').val(moment(commitment.bom_date).format('MM/DD/YYYY'));
                        $('#castingdateval').val(moment(commitment.casting_date).format('MM/DD/YYYY'));

                        
                    } else {
                        $("#final_buffer").val(daysBuffer).trigger('change');
                        $("#assembly_days").val('7').trigger('change');
                        $("#machining_days").val('28').trigger('change');
                    }

                    calculateFinalBuffer();
                    calculateAssemblyDays();
                    calculateMachiningStart();
                    
                }, error: function (err) {
                    console.log("error", err);
                    $("#final_buffer").val(daysBuffer).trigger('change');
                    $("#assembly_days").val('7').trigger('change');
                    $("#machining_days").val('28').trigger('change');
                }
            });
        }

        function calculateFinalBuffer() {
            var final_buffer_input = $("#final_buffer").val();
            console.log("final_buffer_input", final_buffer_input);
            var MaxDelivDateStrDay = moment('@ViewBag.MaxDelivDateStr');
            console.log("MaxDelivDateStrDay", MaxDelivDateStrDay);
            var final_buffer_local = MaxDelivDateStrDay.subtract(parseInt(final_buffer_input), 'days').format('MM/DD/YYYY');
            console.log("final_buffer_local", final_buffer_local, "final_buffer_local domingo", checkDomingo(final_buffer_local))
            final_buffer = checkDomingo(final_buffer_local);
            $('#finalbuffercalculated').text(final_buffer);
            $('#assemblystart').text(final_buffer);

            //Ready to ship que es final buffer + 1 día
            calculateReadyToShip(final_buffer);
            if (permission_user) {
                $("#assembly_days").removeAttr('disabled');
            }
            
        }

        function removeDisabledButton() {
            console.log("entra a removeDisableButton");
            if ($('#assembly_days').val() && $('#machining_days').val() && $('#bomdate').data('date') && $('#castingdate').data('date')) {
                $('#save').removeAttr('disabled')
            } else {
                $('#save').removeAttr('enabled')
            }
        }

        function calculateAssemblyDays(assembly_days) {
            var assembly_days = $('#assembly_days').val();
            assemblydayscalculated = moment(final_buffer).subtract(parseInt(assembly_days), 'days').format('MM/DD/YYYY');
            assemblydayscalculated = checkDomingo(assemblydayscalculated);
            console.log("assemblydayscalculated", assemblydayscalculated);

            $('#assemblydayscalculated').text(assemblydayscalculated);
            if (permission_user) {
                $("#machining_days").removeAttr('disabled');
            }
            //Component date día antes de comenzar ensamble
            calculateComponentDate();

            //Boyout un dia antes de component date
            calculateBoyoutDate(componentdate);
        }

        function calculateReadyToShip(final_buffer) {
            var date = moment(final_buffer).add(1, 'days').format('MM/DD/YYYY');
            $('#readytoship').text(checkDomingo(date));
            $('#readytoshipdiv').show();
        }

        function calculateComponentDate() {
            componentdate = moment(assemblydayscalculated).subtract(1, 'days').format('MM/DD/YYYY');
            componentdate = checkDomingo(componentdate)
            console.log("component date", componentdate);
            $('#machiningend').text(componentdate);
            $('#componentdate').text(componentdate);
            $('#componentdatediv').show();
            $('#machiningenddiv').show();

        }

        function calculateBoyoutDate() {
            boyout_remaining = moment(componentdate).subtract(1, 'days').format('MM/DD/YYYY');
            $('#boyoutdate').text(checkDomingo(boyout_remaining));
            $('#remainingpart').text(checkDomingo(boyout_remaining));
            $('#fabrications').text(checkDomingo(boyout_remaining));

            $('#boyoutdatediv').show();
            $('#remainingpartdiv').show();
            $('#fabricationsdiv').show();
        }

        //Se inicia fundicion dos dias antes que le maquinado.
        function calculateFoundryStart() {
            var foundry = moment(machiningstart).subtract(2, 'days').format('MM/DD/YYYY');
            foundry = checkDomingo(foundry);
            $('#foundry').text(foundry);
            $('#foundrydiv').show();
        }

        function calculateMachiningStart() {
            var machining_days = $("#machining_days").val();
            machiningstart = moment(componentdate).subtract(machining_days, 'days').format('MM/DD/YYYY');
            machiningstart = checkDomingo(machiningstart);

            //foundry dos dias antes del inicio de maquinado
            calculateFoundryStart();
            //Release to manufacturing un dia antes del inicio de maquinado(machiningstart)
            calculateManufacturingDate();
            $('#machiningstart').text(machiningstart);
            $('#machiningstartdiv').show();
        }

        function calculateManufacturingDate() {
            var manufacturing = moment(machiningstart).subtract(1, 'days').format('MM/DD/YYYY');
            manufacturing = checkDomingo(manufacturing);
            $('#manufacturing').text(manufacturing);
            $('#manufacturingdiv').show();
        }

        function checkDomingo(date) {
            var start = moment(date);

            if (start.isoWeekday() === 7) {
                return start.subtract(1, 'days').format('MM/DD/YYYY');
            } else {
                return date;
            }
        }

        $("#view").on('click', function () {
            var dat = {
                ProdOrderNr: '@ViewBag.Assembly',
                SO_Nr: '@ViewBag.SO_Nr',
                SO_Ln: '@ViewBag.SO_Ln',
                SO_Sq: '@ViewBag.SO_Sq'
            };
            console.log("view dat", dat)
            $.ajax({
                url: '/Commitment/getSaleOrder',
                data: dat,
                type: 'GET',
                contentType: 'application/json; charset=utf-8',
                success: function (item) {
                    var W = screen.width - 220;
                    var H = screen.height - 300;
                    var xpos = 100;
                    var ypos = 100;
                    window.open("http://172.20.4.63/RP_TimingPlan/projDetails.aspx?projplan=" + item.projplan + "&planName=" + item.PlanName + "%20%20%20%20%20%20%20%20%20%20%20%20%20%20&company=" + item.BaanCompany, "popup", "toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=yes, resizable=no, " + "width=" + W + ", height=" + H + ", left=" + xpos + ", top=" + ypos);
                }
            });
        });

        $("#assembly_days, #machining_days").on("keypress keyup blur", function (event) {
            $(this).val($(this).val().replace(/[^\d].+/, ""));
            console.log("event whitch", event)
            if ((event.which < 48 || event.which > 57 )) {
                event.preventDefault();
            }
        });

        $("#final_buffer").on("keypress keyup blur", function (event) {
            //$(this).val($(this).val().replace(/[^\d].+/, ""));
            console.log("event whitch", event)
            if ((event.which < 44 || event.which > 57 || event.which === 46 || event.which === 47)) {
                event.preventDefault();
            }
        });

        
    });
</script>
